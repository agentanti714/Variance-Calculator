<!DOCTYPE html>
<html>
<head>
    <title>Variance Calculator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        h1 {
            color: #333;
        }
        p {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>Variance Calculator</h1>
    <p>It tells you the minimum cash to aim for, assuming you use the mean values for calculating your upgrader multipliers.</p>
    <p>Fill in the form below and click the submit button to get the result.</p>
    <p>The default values in the input fields are suggestions.</p>
    <p>lg(Other overall variance) above should include uncertainty from items like Ooftopian Refiner, Temporal Armageddon, and inconsistent upgraders, after all resetters.</p>
    <p>If the calculator returns undefined, it's probably because of the suffix.</p>
    <p>Discord: agentanti714.</p>
    <form>
        <h2>Mine:</h2>
        <label for="mine"></label>
        <select name="mine" id="mine">
            <option value="Havium Mine" selected>Havium Mine</option>
            <option value="Other">Other (No variance)</option>
        </select>

        <h2>Upgraders:</h2>
        <label><input type="checkbox" name="upgrader" value="Astral Setter" checked> Astral Setter</label><br>
        <label><input type="checkbox" name="upgrader" value="Meralin's Sorcery" checked> Meralin's Sorcery</label><br>
        <label><input type="checkbox" name="upgrader" value="Reaper's Fortress" checked> Reaper's Fortress</label><br>
        <label><input type="checkbox" name="upgrader" value="Final Faberge" checked> Final Faberge</label><br>
        <label><input type="checkbox" name="upgrader" value="Midas Blaster" checked> Midas Blaster</label><br>
        <label><input type="checkbox" name="upgrader" value="Legendary Peppermint" checked> Legendary Peppermint</label><br>
        <label><input type="checkbox" name="upgrader" value="Enchanted Library" checked> Enchanted Library</label><br><br>
        <label>lg(Other overall variance): <input type="text" name="other variance" pattern="[0-9]*\.[0-9]+|[0-9]*" title="Numbers only" placeholder="Numbers only" value="0.3"></label><br>
        <label>No. of resetters: <input type="number" name="resetter count" value="4" min="0" max="4" step="1" title="Between 0 and 4"/></label><br>
        <label>Probability of success: <input type="text" name="success chance" pattern="0(\.\d+)?|1\.0|1" title="Numbers only" placeholder="Numbers only" value="0.9992137"></label><br>
        <button type="submit">Submit</button>
    </form>
    <h2 id="result" style="background-color: yellow;"></h2>
</body>
<script>
    document.querySelector('form').addEventListener('submit', function(event){
        event.preventDefault();

        // Get the values from the form
        var mine = document.querySelector('select[name="mine"]').value;
        var upgraders = Array.from(document.querySelectorAll('input[name="upgrader"]:checked')).map(function(checkbox) {
            return checkbox.value;
        });
        var additionalVariance = parseFloat(document.querySelector('input[name="other variance"]').value);
        var resetterCount = parseInt(document.querySelector('input[name="resetter count"]').value);
        var successChance = parseFloat(document.querySelector('input[name="success chance"]').value);

        // Calculate the result
        const minesToVariances = new Map([
            ['Havium Mine', 0.0827552697442],
            ['Other', 0],
        ]);
        const upgradersToVariances = new Map([
            ['Havium Mine', 0.0827552697442],
            ['Astral Setter', 0.13323048167015814],
            ['Meralin\'s Sorcery', 0.002435765663214982],
            ['Reaper\'s Fortress', 0.0036113960632035477],
            ['Final Faberge', 0.008246456248093403],
            ['Midas Blaster', 0.04329382557027653],
            ['Legendary Peppermint', 0.006147545488536342],
            ['Enchanted Library', 0.006510393605178625],
        ]);

        var result = 0;
        var mine = 0

        mine = minesToVariances.get('Havium Mine');

        upgraders.forEach(function(upgrader) {
            result += upgradersToVariances.get(upgrader) * (resetterCount + 1); //upgraders
        });

        result = mine + result + additionalVariance; //lg(overall variance)
        result = Math.sqrt(result); //lg(overall standard deviation)
        
        // Find x, given P(N(0,1) <= x) = successChance, inverse of the normal distribution
        function NormSInv(p) {
            var a1 = -39.6968302866538, a2 = 220.946098424521, a3 = -275.928510446969;
            var a4 = 138.357751867269, a5 = -30.6647980661472, a6 = 2.50662827745924;
            var b1 = -54.4760987982241, b2 = 161.585836858041, b3 = -155.698979859887;
            var b4 = 66.8013118877197, b5 = -13.2806815528857, c1 = -7.78489400243029E-03;
            var c2 = -0.322396458041136, c3 = -2.40075827716184, c4 = -2.54973253934373;
            var c5 = 4.37466414146497, c6 = 2.93816398269878, d1 = 7.78469570904146E-03;
            var d2 = 0.32246712907004, d3 = 2.445134137143, d4 = 3.75440866190742;
            var p_low = 0.02425, p_high = 1 - p_low;
            var q, r;
            var retVal;

            if ((p < 0) || (p > 1))
            {
                alert("NormSInv: Argument out of range.");
                retVal = 0;
            }
            else if (p < p_low)
            {
                q = Math.sqrt(-2 * Math.log(p));
                retVal = (((((c1 * q + c2) * q + c3) * q + c4) * q + c5) * q + c6) / ((((d1 * q + d2) * q + d3) * q + d4) * q + 1);
            }
            else if (p <= p_high)
            {
                q = p - 0.5;
                r = q * q;
                retVal = (((((a1 * r + a2) * r + a3) * r + a4) * r + a5) * r + a6) * q / (((((b1 * r + b2) * r + b3) * r + b4) * r + b5) * r + 1);
            }
            else
            {
                q = Math.sqrt(-2 * Math.log(1 - p));
                retVal = -(((((c1 * q + c2) * q + c3) * q + c4) * q + c5) * q + c6) / ((((d1 * q + d2) * q + d3) * q + d4) * q + 1);
            }

            return retVal;
        }
        var x = NormSInv(successChance);
        result = Math.pow(10, result * x);
        result = result * 10 //due to rebirth price being 10 NONONGNTL
        
        // Format the result
        const suffixes = ['OTNONGNTL', 'NONONGNTL', 'CENT', 'UNCENT']
        index = Math.floor(Math.log10(result)/3) //due to rebirth price being 10 NONONGNTL
        result = '$' + String((result/(Math.pow(1000, (index)))).toPrecision(5)) + ' ' + suffixes[index + 1]

        document.querySelector('#result').textContent = 'The minimum cash to aim for is ' + result + '.';
    });
</script>
<noscript>
    <p>Please enable JavaScript to use this calculator.</p>
</noscript>
</html>